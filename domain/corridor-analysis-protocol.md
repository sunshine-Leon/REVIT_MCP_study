---
description: èµ°å»Šé˜²ç«åˆ†æèˆ‡æ¨™è¨»æ¨™æº–æµç¨‹ (SOP)
trigger_keywords:
  - èµ°å»Š
  - å»Šé“
  - å¯¬åº¦åˆ†æ
  - é˜²ç«åˆ†æ
  - æ¯”å°æ³•è¦
version: 2026-02-13
---

# èµ°å»Šé˜²ç«åˆ†æèˆ‡æ¨™è¨»ç­–ç•¥ (Corridor Analysis Protocol)

> **ç›®çš„**: å»ºç«‹ä¸€å¥—æ¨™æº–åŒ–çš„æµç¨‹ï¼Œç”¨æ–¼è‡ªå‹•åµæ¸¬ Revit ä¸­çš„èµ°å»Šå…ƒç´ ã€åˆ†ææ·¨å¯¬æ˜¯å¦ç¬¦åˆæ³•è¦ä¸¦è‡ªå‹•å»ºç«‹æ¨™è¨»ã€‚

## ğŸ“‹ æ ¸å¿ƒé‚è¼¯
1. **è­˜åˆ¥ (Identification)**:
   - ç¯©é¸æˆ¿é–“åç¨±åŒ…å«: `èµ°å»Š`, `Corridor`, `å»Šé“`, `é€šé“`, `å»Šä¸‹` (æ—¥æ–‡), `å»Š`ã€‚
2. **å®šä½ (Localization)**:
   - å–å¾—æˆ¿é–“çš„ `BoundingBox`ã€‚
   - æ ¹æ“š BoundingBox çš„æœ€å¤§ã€æœ€å°åº§æ¨™è¨ˆç®—ä¼°è¨ˆé•·å¯¬ã€‚
3. **åˆ†æ (Analysis)**:
   - æª¢æŸ¥å¯¬åº¦æ˜¯å¦ç¬¦åˆå»ºç¯‰æŠ€è¡“è¦å‰‡ï¼ˆ1.2m èˆ‡ 1.6m é–¥å€¼ï¼‰ã€‚
4. **æ¨™è¨» (Annotation)**:
   - ä½¿ç”¨ `create_dimension` åœ¨æˆ¿é–“ BoundingBox çš„ä¸­å¿ƒç·šä¸Šå»ºç«‹æ¨™è¨»ã€‚
   - å¿…é ˆæŒ‡å®šèˆ‡æˆ¿é–“ä¸€è‡´çš„æ¨“å±¤ (`LevelId`) ä¸¦é¸æ“‡æ­£ç¢ºçš„è¦–åœ–ã€‚

## ğŸ› ï¸ æˆåŠŸå·¥å…·çµ„åˆç¯„ä¾‹
```javascript
// å–å¾—ç•¶å‰æ¨“å±¤èµ°å»Š
const rooms = await call('get_rooms_by_level', { levelId: currentLevelId });
const corridor = rooms.find(r => r.name.includes('å»Šä¸‹'));

// æ ¹æ“š BoundingBox ä¸­å¿ƒé»å»ºç«‹å°ºå¯¸æ¨™è¨»ç·š
const centerStart = { x: min.x, y: (min.y + max.y) / 2, z: 0 };
const centerEnd = { x: max.x, y: (min.y + max.y) / 2, z: 0 };

await call('create_dimension', {
    elements: [corridor.id],
    type: 'Linear',
    viewId: activeViewId,
    line: { start: centerStart, end: centerEnd }
});
```

## âš ï¸ æ³¨æ„äº‹é …
- **åº§æ¨™ç³»**: æ¨™è¨»çš„ä½ç½®ç·šå¿…é ˆä½æ–¼å…ƒç´ å…§éƒ¨çš„ä¸­å¿ƒ,å¦å‰‡æ¨™è¨»å¯èƒ½ç„¡æ³•é¡¯ç¤ºæˆ–å°é½Šã€‚
- **è¦–åœ–ç›¸å®¹æ€§**: æ¨™è¨»å¿…é ˆå»ºç«‹åœ¨å¹³é¢è¦–åœ– (FloorPlan) ä¸­ã€‚

## ğŸ§® å¯¬åº¦è¨ˆç®—æ–¹æ³•

### æ–¹æ³• 1: Boundary Segments (æ¨è–¦)
- **é©ç”¨**: ä»»æ„è§’åº¦çš„èµ°å»Š (åŒ…å«æ–œå‘èµ°å»Š)
- **åŸç†**: è¨ˆç®—æœ€é•·çš„å…©æ¢å¹³è¡Œç·šæ®µä¹‹é–“çš„å‚ç›´è·é›¢
- **ç²¾ç¢ºåº¦**: Â±10mm
- **æ¼”ç®—æ³•**:
  1. å–å¾—æˆ¿é–“çš„æ‰€æœ‰é‚Šç•Œç·šæ®µ
  2. æ‰¾å‡ºè§’åº¦å·® < 5Â° çš„å¹³è¡Œç·šæ®µå°
  3. é¸æ“‡å¹³å‡é•·åº¦æœ€é•·çš„å¹³è¡Œç·šæ®µå° (èµ°å»Šå…©å´ç‰†)
  4. è¨ˆç®—å…©æ¢å¹³è¡Œç·šæ®µä¹‹é–“çš„å‚ç›´è·é›¢

### æ–¹æ³• 2: BoundingBox (é™ç´š)
- **é©ç”¨**: åƒ…é™å‚ç›´/æ°´å¹³èµ°å»Š
- **åŸç†**: å– X/Y æ–¹å‘è¼ƒå°å€¼
- **ç²¾ç¢ºåº¦**: æ–œå‘èµ°å»Šæœƒåš´é‡éŒ¯èª¤ (å¯èƒ½èª¤å·® 10 å€ä»¥ä¸Š)
- **é™åˆ¶**: å°æ–¼æ–œå‘èµ°å»Š,BoundingBox æ˜¯è»¸å°é½ŠçŸ©å½¢,åŒ…å«å¤§é‡ç©ºç™½å€åŸŸ

### è‡ªå‹•é™ç´šé‚è¼¯
1. å„ªå…ˆå˜—è©¦ Boundary Segments
2. å¦‚æœç„¡æ³•å–å¾— (æˆ¿é–“æœªå°é–‰ã€æœªæ”¾ç½®ç­‰) â†’ ä½¿ç”¨ BoundingBox
3. çµæœä¸­æ¨™è¨»ä½¿ç”¨çš„æ–¹æ³•:
   - `method: "boundary_accurate"` - ç²¾ç¢ºè¨ˆç®—
   - `method: "bbox_estimate"` - ä¼°ç®— (ä¸ç²¾ç¢º)

```javascript
import { calculateCorridorWidth } from '../src/utils/corridor-geometry.js';

const result = calculateCorridorWidth(
    roomData.BoundarySegments, 
    roomData.BoundingBox
);

console.log(`å¯¬åº¦: ${result.width.toFixed(1)} mm`);
console.log(`æ–¹æ³•: ${result.method}`);
```

## ğŸ”€ å¤šå€æ®µèµ°å»Šåˆ†æ (Segment-First Algorithm)

### é©ç”¨å ´æ™¯
- L å‹èµ°å»Š / T å‹èµ°å»Š / åå­—å‹èµ°å»Š
- ä»»ä½•æœ‰åˆ†æ”¯æˆ–è½‰æŠ˜çš„èµ°å»Š
- å–®ä¸€æˆ¿é–“ ID æ¶µè“‹å¤šå€‹å¹¾ä½•å€æ®µçš„æƒ…æ³

### æ ¸å¿ƒæ¼”ç®—æ³•: ç·šæ®µå„ªå…ˆåˆ†æ (Segment-First Analysis)

ç‚ºäº†é©æ‡‰å„ç¨®è¤‡é›œçš„èµ°å»Šå½¢ç‹€,æˆ‘å€‘æ¡ç”¨ã€Œç·šæ®µå„ªå…ˆã€çš„åˆ†æç­–ç•¥,è€Œéå‚³çµ±çš„åœ–å½¢åˆ‡å‰²ã€‚

#### æ­¥é©Ÿ 1: ç·šæ®µé è™•ç†èˆ‡ç¯©é¸
å°æˆ¿é–“é‚Šç•Œçš„æ‰€æœ‰ç·šæ®µé€²è¡Œéæ­·:
1. **å¹³å½¢ç·šåµæ¸¬**: ç‚ºæ¯æ¢ç·šæ®µå°‹æ‰¾èˆ‡å…¶å¹³è¡Œçš„æ‰€æœ‰å…¶ä»–ç·šæ®µã€‚
2. **å¯¬åº¦è¨ˆç®—**: è¨ˆç®—åˆ°æœ€è¿‘å¹³è¡Œç·šæ®µçš„å‚ç›´è·é›¢ (Width)ã€‚
3. **å…±ç·šæ’é™¤ (Collinear Filtering)**:
   - è‹¥å¹³è¡Œç·šæ®µè·é›¢æ¥µè¿‘ (ä¾‹å¦‚ < 100mm),è¦–ç‚ºåŒä¸€å´ç‰†å£çš„é€£çºŒåˆ†æ®µæˆ–é–‹å£,äºˆä»¥æ’é™¤ã€‚
   - ç¢ºä¿æ‰¾åˆ°çš„æ˜¯ã€Œé¢å°é¢ã€çš„ç‰†å£ã€‚
4. **é•·å¯¬æ¯”éæ¿¾ (Aspect Ratio Filtering)**:
   - è¨ˆç®— `Ratio = ç·šæ®µé•·åº¦ / å¯¬åº¦`
   - è‹¥ `Ratio < 1.0`, è¦–ç‚ºèµ°å»Šçš„çŸ­é‚Š (æœ«ç«¯æˆ–è½‰è§’), æ¨™è¨˜ç‚ºç„¡æ•ˆã€‚
   - è‹¥ `Ratio >= 1.0`, è¦–ç‚ºèµ°å»Šçš„é•·é‚Š (ä¸»è¦é‚Šç•Œ), ä¿ç•™åˆ†æã€‚

#### æ­¥é©Ÿ 2: å€æ®µé…å°èˆ‡å»ºç«‹
å°‡ç¯©é¸å¾Œçš„æœ‰æ•ˆé•·é‚Šé€²è¡Œé…å°:
1. æ‰¾å‡ºäº’ç›¸å¹³è¡Œçš„æœ‰æ•ˆé•·é‚Šå°ã€‚
2. æª¢æŸ¥å…©ç·šæ®µåœ¨æŠ•å½±æ–¹å‘ä¸Šæ˜¯å¦æœ‰é‡ç–Š (Projection Overlap)ã€‚
3. å°‡é…å°æˆåŠŸçš„ç·šæ®µå®šç¾©ç‚ºä¸€å€‹ã€Œèµ°å»Šå€æ®µ (Corridor Segment)ã€ã€‚

#### æ­¥é©Ÿ 3: åˆè¦æ€§æª¢æŸ¥
å°æ¯å€‹å€æ®µé€²è¡Œèˆ‡æ³•è¦çš„å°æ¯”åˆ†æ:
1. **å¯¬åº¦æª¢æŸ¥**: æ˜¯å¦æ»¿è¶³æœ€å°æ·¨å¯¬ (ä¾‹å¦‚ 1200mm)ã€‚
2. **ç“¶é ¸æ¨™ç¤º**: æ¨™è¨˜ä¸åˆæ ¼çš„å€æ®µä½ç½®ã€‚

### å„ªé»
- **ç„¡éœ€åƒæ•¸**: è‡ªå‹•é©æ‡‰ä»»ä½•å°ºåº¦çš„èµ°å»Š,ç„¡éœ€äººå·¥è¨­å®šé–¾å€¼ã€‚
- **æŠ—å¹²æ“¾**: èƒ½æœ‰æ•ˆè™•ç†ç‰†å£åˆ†æ®µã€æŸ±å­çªå‡ºã€é–€çª—é–‹å£ç­‰å¹¾ä½•å¹²æ“¾ã€‚
- **å¹¾ä½•ç›´è§€**: ç›´æ¥åŸºæ–¼èµ°å»Šã€Œç´°é•·å½¢ã€çš„æœ¬è³ªç‰¹å¾µé€²è¡Œåˆ†æã€‚

### ä½¿ç”¨ç¯„ä¾‹ (SDK)

```javascript
import { analyzeMultiSegmentCorridor } from '../src/utils/corridor-geometry.js';

const result = analyzeMultiSegmentCorridor(
    roomData.BoundarySegments,
    1200  // æœ€å°å¯¬åº¦ 1.2m
);

console.log(`å€æ®µæ•¸é‡: ${result.totalSegments}`);
console.log(`æœ€å°å¯¬åº¦: ${result.minWidth} mm`);
console.log(`æ•´é«”çµæœ: ${result.allPass ? 'PASS' : 'FAIL'}`);

// é¡¯ç¤ºä¸åˆæ ¼å€æ®µ
if (!result.allPass) {
    result.failedSegments.forEach(seg => {
        console.log(`[FAIL] å€æ®µ ${seg.segmentIndex + 1}`);
        console.log(`  - å¯¬åº¦: ${seg.width} mm`);
        console.log(`  - é•·åº¦: ${seg.length} mm`);
        console.log(`  - ä¸­å¿ƒ: (${seg.centerPoint.x}, ${seg.centerPoint.y})`);
    });
}
```
